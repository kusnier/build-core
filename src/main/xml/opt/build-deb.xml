<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-deb" basedir=".">
  
  <property name="build.debdir" value="${build.origdir}/debian"/>
  <property file="${build.debdir}/build.properties" prefix="deb.prop"/>
  <property name="build.target.deb.data" value="${build.target.deb}${deb.prop.path}"/>
  <property name="build.target.deb.ctl" value="${build.target.deb}/DEBIAN/"/>

  <target name="-deb:compile:clear" depends="-app:compile:clear"/>

  <target name="-deb:compile" extensionOf="pre-package" depends="-app:compile"/>

  <target name="deb:pre-package" extensionOf="pre-package" depends="app:pre-package">
  
    <!-- Just copy all data from app build -->
    <copy todir="${build.target.deb.data}/${ivy.module}-${ivy.new.revision}/${ivy.module}">
      <fileset dir="${build.target.app}" excludes="**/.extracted conf/apache/*.conf"/>
    </copy>

    <!-- Copy Apache configuration, if exist -->
    <copy todir="${build.target.deb}/etc/apache2/sites-available">
      <fileset dir="${build.target.app}/conf/apache" includes="*.conf" erroronmissingdir="false"/>
      <filterset>
        <filter token="BASEPATH" value="${deb.prop.path}/${ivy.module}-${ivy.new.revision}"/>
        <filter token="MODULENAME" value="${ivy.module}"/>
      </filterset>
    </copy>
  </target>
  
  <target name="deb:package:descriptor" extensionOf="pre-package" depends="app:package:descriptor">
  
    <!-- Calculate package installation size -->
    <length property="deb.length" mode="all">
      <fileset dir="${build.target.deb.data}" includes="**"/>
    </length>
    <math result="deb.length.kb" operation="/" operand1="${deb.length}" operand2="1024" datatype="int"/>
    
    <!-- Copy debian control files and replace some tokens -->
    <copy todir="${build.target.deb.ctl}">
      <fileset dir="${build.debdir}">
        <include name="control"/>
        <include name="postinst"/>
        <include name="prerm"/>
      </fileset>
      <filterset filtersfile="${build.debdir}/build.properties">
        <filter token="size" value="${deb.length.kb}"/>
        <filter token="module" value="${ivy.module}"/>
        <filter token="version" value="${ivy.new.revision}"/>
        <filter token="section" value="${ivy.organisation}"/>
      </filterset>
    </copy>
    <chmod file="${build.target.deb.ctl}/preinst" perm="0775"/>
    <chmod file="${build.target.deb.ctl}/postinst" perm="0775"/>
    <chmod file="${build.target.deb.ctl}/prerm" perm="0775"/>
  </target>

  <target name="deb:package" extensionOf="package" depends="app:package">
  
    <!-- Build package using dpkg-deb -->
    <exec executable="dpkg-deb">
      <arg value="-b"/>
      <arg value="${build.target.deb}"/>
      <arg value="${build.target}/${ivy.module}-${ivy.new.revision}.deb"/>
    </exec>
  </target>
</project>
