<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-tagdeploy" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">

  <target name="-publish:tag:clean" depends="-publish:tag:gettagname">
    <delete dir="${build.target}/${xp.build.tag}"/>
  </target>

  <target name="-publish:tag:fetchapp" depends="xp.provide.dependencies, xp.setup.ivy, -publish:tag:gettagname" unless="xp.tag.uselocal">
    <echo>===> Deploying to tag ${xp.build.tag}</echo>
    <echo>     Repository: ${ivy.extra.repository}</echo>
    <echo>     Current version: ${tag.version}</echo>

    <!-- Retrieve application artifacts and store in xp.artifacts.app -->
    <ivy:cachefileset
     inline="true"
     organisation="${ivy.organisation}"
     module="${ivy.module}"
     revision="${tag.version}"
     type="app"
     setid="xp.artifacts.app"
     transitive="false"
    />
  </target>

  <target name="-publish:tag:uselocalapp" depends="xp.provide.dependencies, xp.setup.ivy, xp.build.number, -publish:tag:gettagname">
    <property name="xp.tag.uselocal" value="true"/>
    <echo>===> Deploying to tag ${xp.build.tag}</echo>
    <echo>     Repository: ${ivy.extra.repository}</echo>
    <echo>     Current version: ${tag.version}</echo>

    <fileset id="xp.artifacts.app" dir="${build.target}" includes="${ivy.module}-app-${ivy.new.revision}.zip"/>
  </target>

  <target name="-publish:tag:sync" description="Publish latest app artifact into tag"
   depends="-publish:tag:fetchapp, -publish:tag:gettagname, -publish:tag:getwc, xp.build.number"
  >

    <!-- Extract application artifacts to SVN checkout -->
    <sync todir="${build.target}/${xp.build.tag}" includeEmptyDirs="true" overwrite="true">
      <zipfileset>
        <zipfileset refid="xp.artifacts.app"/>
      </zipfileset>
      <preserveintarget>
        <include name="**/.svn/**"/>
      </preserveintarget>
    </sync>

    <!-- Create build-version file -->
    <property name="logfile" value="${build.target}/${xp.build.tag}/${ivy.module}-info.txt"/>
    <tstamp>
      <format property="publish.date" pattern="yyyy-MM-dd'T'HH:mm:ss.SSSZ"/>
    </tstamp>

    <echo file="${logfile}">This deployment was done using the following meta data:

User:       ${user.name}
Artifact:   ${ivy.organisation}#${ivy.module}
Version:    ${tag.version}
Date:       ${publish.date}
Build with: ${xp.build.version}
    </echo>

    <!-- Merge changes (svn delete deleted, svn add added, then commit -->
    <svn svnkit="true" javahl="true" failonerror="true">
      <add force="true" recurse="true">
        <svnFileSet dir="${build.target}/${xp.build.tag}/"/>
      </add>
      <delete>
        <svnFileSet dir="${build.target}/${xp.build.tag}/">
          <svnMissing/>
        </svnFileSet>
      </delete>

      <propset path="${build.target}/${xp.build.tag}" name="xp.ivy.version" value="${ivy.revision}"/>
    </svn>
  </target>

  <target name="-publish:tag:getwc" depends="-publish:tag:check, -publish:tag:checkout, -publish:tag:update"/>

  <target name="-publish:tag:check" depends="-publish:tag:gettagname">
    <available property="xp.publish.checkedout" file="${build.target}/${xp.build.tag}"/>
  </target>

  <target name="-publish:tag:checkout" depends="-publish:tag:gettagname" unless="xp.publish.checkedout">
    <svn svnkit="true" javahl="false" failonerror="true">
      <checkout url="${ivy.extra.repository}/${xp.build.tag}" destPath="${build.target}/${xp.build.tag}"/>
    </svn>
  </target>

  <target name="-publish:tag:update" depends="-publish:tag:gettagname" if="xp.publish.checkedout">
    <svn svnkit="true" javahl="true" failonerror="true">
      <update dir="${build.target}/${xp.build.tag}"/>
    </svn>
  </target>

  <target name="-publish:tag:gettagname" depends="xp.build.mode, -publish:tag:tagname.integration, -publish:tag:tagname.release, -publish:tag:tagname.milestone"/>

  <target name="-publish:tag:tagname.release" if="xp.build.mode.release">
    <property name="xp.build.tag">${ivy.extra.tag}_RELEASE</property>
    <property name="tag.version">${ivy.revision}</property>
  </target>

  <target name="-publish:tag:tagname.milestone" if="xp.build.mode.milestone">
    <property name="xp.build.tag">${ivy.extra.tag}_QARELEASE</property>
    <property name="tag.version">${ivy.revision}</property>
  </target>

  <target name="-publish:tag:tagname.integration" if="xp.build.mode.integration">
    <property name="xp.build.tag">${ivy.extra.tag}_LATEST</property>
    <property name="tag.version">${ivy.revision}-SNAPSHOT</property>
  </target>

  <target name="-publish:tag:commit" unless="xp.simulate">
    <svn svnkit="true" javahl="false" failonerror="true">
      <commit dir="${build.target}/${xp.build.tag}" message="- Publishing ${ivy.module}-${ivy.revision}"/>
    </svn>
  </target>

  <target name="publish:tagdiff" depends="-publish:tag:uselocalapp, -publish:tag:sync">
    <mkdir dir="${build.target.reports}"/>
    <svn svnkit="false" javahl="true" failonerror="true">
      <diff oldPath="${build.target}/${xp.build.tag}" outfile="${build.target.reports}/tag.diff"/>
    </svn>

    <loadfile property="diffoutput" srcFile="${build.target}/reports/tag.diff"/>
    <echo>${diffoutput}</echo>
  </target>

  <target name="publish:tag" depends="-publish:tag:sync, -publish:tag:commit"/>
</project>