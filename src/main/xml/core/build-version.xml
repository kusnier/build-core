<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-version" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
  
  <target name="xp.build.mode" depends="xp.setup.ivy">
    <condition property="xp.build.mode.release">
      <equals arg1="${ivy.status}" arg2="release"/>
    </condition>

    <condition property="xp.build.mode.milestone">
      <equals arg1="${ivy.status}" arg2="milestone"/>
    </condition>

    <condition property="xp.build.mode.integration">
      <equals arg1="${ivy.status}" arg2="integration"/>
    </condition>
  </target>

  <target name="xp.get.resolver" depends="xp.build.mode, xp.get.resolver.integration, xp.get.resolver.milestone, xp.get.resolver.release"/>

  <target name="xp.get.resolver.integration" if="xp.build.mode.integration">
    <property name="xp.publish.resolver" value="shared-publish-snapshots"/>
    <property name="xp.overwrite" value="true"/>
  </target>

  <target name="xp.get.resolver.milestone" if="xp.build.mode.milestone">
    <property name="xp.publish.resolver" value="shared-publish-milestones"/>
  </target>

  <target name="xp.get.resolver.release" if="xp.build.mode.release">
    <property name="xp.publish.resolver" value="shared-publish-releases"/>
  </target>

  <target name="xp.build.number.release" depends="xp.build.mode" if="xp.build.mode.release" unless="xp.property.fromfile">
    <property name="ivy.new.revision" value="${ivy.revision}"/>
  </target>

  <target name="xp.build.number.milestone" depends="xp.build.mode, xp.get.resolver" if="xp.build.mode.milestone" unless="xp.property.fromfile">
    <ivy:buildnumber 
     organisation="${ivy.organisation}"
     module="${ivy.module}"
     revision="${ivy.revision}-RC"
     revSep=""
     defaultBuildNumber="1"
     resolver="${xp.publish.resolver}"
    />
  </target>

  <target name="xp.build.number.integration" depends="xp.build.mode, xp.get.resolver" if="xp.build.mode.integration" unless="xp.property.fromfile">
    <property name="ivy.new.revision" value="${ivy.revision}-SNAPSHOT"/>
  </target>

  <!--
   ! Evaluate build number, then store to xp.properties
   !-->
  <target name="xp.build.number.evaluate"
   depends="xp.build.number.release, xp.build.number.milestone, xp.build.number.integration"
   unless="xp.property.fromfile"
  >
    <echo>Determining next build number...</echo>
    <property name="xp.property.fromfile" value="(cached)"/>
    <echoproperties destfile="${build.target}/xp.properties">
      <propertyset>
        <propertyref name="ivy.new.revision"/>
        <propertyref name="xp.publish.resolver"/>
        <propertyref name="xp.property.fromfile"/>
      </propertyset>
    </echoproperties>
  </target>

  <!--
   ! First, try to load last settings from xp.properties; if succeeds, no need
   ! to do expensive number calculation...
   !-->
  <target name="xp.build.number.load">
    <property file="${build.target}/xp.properties"/>
  </target>

  <target name="xp.build.number" depends="xp.build.number.load, xp.build.number.evaluate">
    <echo>Current build version: ${ivy.new.revision} ${xp.property.fromfile}</echo>
    <echo>Current build mode   : ${ivy.status} ${xp.property.fromfile}</echo>
  </target>
</project>