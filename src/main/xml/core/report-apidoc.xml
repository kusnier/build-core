<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-report-apidoc" basedir=".">

  <target name="xp.compile.generate.apidoc.check">
    <pathconvert property="xp.forge.apidoc.dependency" setonempty="false">
      <fileset dir="${build.target}" includes="lib/compile/xar/apidoc-*.xar"/>
    </pathconvert>

    <condition property="xp.forge.apidoc.available">
      <and>
        <isset property="xp.forge.apidoc.dependency"/>
        <isset property="build.package"/>
      </and>
    </condition>
  </target>

  <!--
   ! Generate apidoc for package
   !
   ! This requires that you have:
   ! * a dependency to net.xp_forge#apidoc
   ! * a "package" attribute in your ivy.xml's <info> tag
   ! * have a "compile" configuration
   !
   !-->
  <target name="xp.compile.generate.apidoc" extensionOf="compile" depends="xp.compile.generate.apidoc.check" if="xp.forge.apidoc.available">
    <mkdir dir="${build.target.reports.documentation}"/>
    <tstamp>
      <format property="TODAY" pattern="yyyy-MM-dd HH:mmZZZZZ" locale="en,UK"/>
    </tstamp>

    <exec
     executable="doclet"
     failonerror="true"
     dir="${build.target}/bootstrap/compile"
    >
      <env key="USE_XP" value="${build.target}/bootstrap/compile/"/>
      <arg value="net.xp_forge.apidoc.Doclet"/>
      <arg value="${build.package}.**"/>
      <arg value="-output"/>
      <arg value="${build.target.reports.documentation}"/>
      <arg value="-api"/>
      <arg value="${ivy.organisation}#${ivy.module}"/>
      <arg value="-css"/>
      <arg value="res://css/default.css"/>
      <arg value="-gen"/>
      <arg value="Version ${ivy.new.revision} - generated ${TODAY}"/>
    </exec>
    <echo> :: Apidoc generated to ${build.target.reports.documentation}</echo>
  </target>

  <target name="xp.package.apidoc" extensionOf="package" depends="xp.compile.generate.apidoc.check" if="xp.forge.apidoc.available">
    <zip file="${build.target}/${ivy.module}-${ivy.new.revision}-apidoc.zip" >
      <zipfileset dir="${build.target.reports.documentation}" includes="**/*" prefix="${ivy.module}/"/>
    </zip>
  </target>
</project>