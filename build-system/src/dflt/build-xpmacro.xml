<?xml version="1.0"?>
<project name="xp-framework-macro" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
  
  <macrodef name="xar">
    <attribute name="target"/>
    <attribute name="dir"/>
    
    <sequential>
      <!-- Build classpath for xar -->
      <ivy:cachefileset
       type="xar"
       conf="default"
       setid="xar.path.dependencies"
      />
      <xar-with-cp target="@{target}" dir="@{dir}">
        <classpath><fileset refid="xar.path.dependencies"/></classpath>
      </xar-with-cp>
    </sequential>
  </macrodef>

  <macrodef name="xar-with-cp">
    <attribute name="target"/>
    <attribute name="dir"/>
    <element name="classpath"/>

    <sequential>
      <pathconvert property="xar.path" pathsep="&#10;">
        <classpath/>
      </pathconvert>

      <!-- Generate ivy.pth for use by xar -->
      <echo file="${build.target}/bootstrap/ivy.pth">${xar.path}</echo>

      <exec
       executable="xar"
       failonerror="true"
       dir="@{dir}"
      >
        <env key="USE_XP" value="${build.target}/bootstrap"/>
        <arg value="cf"/>
        <arg value="@{target}"/>
        <arg value="."/>
      </exec>
    </sequential>
  </macrodef>
</project>
