<?xml version="1.0"?>
<project name="xp-framework-macro" basedir=".">
  
  <macrodef name="xar">
    <attribute name="target"/>
    <attribute name="dir"/>
    
    <sequential>

      <!-- Build classpath for xar -->
      <fileset id="xar.path.dependencies" dir="${build.target}/lib" includes="default/xar/*.xar"/>
      <xar-with-cp target="@{target}" dir="@{dir}">
        <classpath>
          <fileset refid="xar.path.dependencies"/>
          <path>
            <pathelement path="${build.target}/bootstrap"/>
          </path>
        </classpath>
      </xar-with-cp>
    </sequential>
  </macrodef>

  <macrodef name="xar-with-cp">
    <attribute name="target"/>
    <attribute name="dir"/>
    <element name="classpath"/>

    <sequential>
      <pathconvert property="xar.path" pathsep="&#10;">
        <classpath/>
      </pathconvert>

      <!-- Generate ivy.pth for use by xar -->
      <echo file="${build.target}/bootstrap/ivy.pth">${xar.path}</echo>

      <exec
       executable="xar"
       failonerror="true"
       dir="@{dir}"
      >
        <env key="USE_XP" value="${build.target}/bootstrap"/>
        <arg value="cf"/>
        <arg value="@{target}"/>
        <arg value="."/>
      </exec>
    </sequential>
  </macrodef>
</project>
