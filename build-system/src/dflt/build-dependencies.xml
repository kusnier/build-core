<?xml version="1.0"?>
<project name="xp-framework-build-install" basedir=".">
  <!-- Automatically download ivy & load library -->
  <property name="ivy.install.version" value="2.2.0" />
  <property name="xp.build.lib.dir" value="${user.home}/.ant/lib" />
  <property name="ivy.jar.file" value="${xp.build.lib.dir}/ivy-${ivy.install.version}.jar" />

  <antversion property="xp.ant.version" atleast="1.8.2"/>
  <available property="xp.deps.available.ivy" file="${ivy.jar.file}"/>
  <available property="xp.deps.available.ivysvn" file="${xp.build.lib.dir}/ivysvnresolver.jar"/>
  <available property="xp.deps.available.svnant" file="${xp.build.lib.dir}/svnant.jar"/>
  <available property="xp.deps.available.jsch" file="${xp.build.lib.dir}/jsch-0.1.44.jar"/>

  <target name="xp.provide.dependencies" depends="xp.check.ant, xp.install.ivy, xp.install.ivysvn, xp.install.svnant, xp.install.jsch">
   	<path id="ivy.lib.path">
      <fileset dir="${xp.build.lib.dir}">
        <include name="ivy-${ivy.install.version}.jar"/>
        <include name="ivysvnresolver.jar"/>
      </fileset>
  	</path>
  	<typedef
     resource="org/apache/ivy/ant/antlib.xml"
  	 uri="antlib:org.apache.ivy.ant"
     classpathref="ivy.lib.path"
    />

    <taskdef resource="org/tigris/subversion/svnant/svnantlib.xml">
      <classpath>
        <fileset dir="${xp.build.lib.dir}">
          <include name="svnant.jar"/>
          <include name="svnkit.jar"/>
          <include name="svnjavahl.jar"/>
          <include name="ganymed.jar"/>
          <include name="svnClientAdapter.jar"/>
        </fileset>
      </classpath>
    </taskdef>
  </target>

  <target name="xp.check.ant" unless="xp.ant.version">
    <fail>At least ant 1.8.2 required</fail>
  </target>

  <target name="xp.install.ivy" unless="xp.deps.available.ivy">
  	<mkdir dir="${xp.build.lib.dir}"/>

    <echo message="Downloading &amp; loading ivy..."/>
  	<get
     src="http://repo1.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar"
     dest="${ivy.jar.file}" 
     usetimestamp="true"
     verbose="true"
    />
  </target>
  
  <target name="xp.install.ivysvn" unless="xp.deps.available.ivysvn">
    <get
     src="http://ivysvn.googlecode.com/files/ivysvnresolver-2.2.0-bin.tgz"
     dest="${xp.build.lib.dir}"
     usetimestamp="true"
     verbose="true"
    />
    <untar 
     src="${xp.build.lib.dir}/ivysvnresolver-2.2.0-bin.tgz"
     dest="${xp.build.lib.dir}"
     compression="gzip"
    >
      <patternset>
        <include name="**/*.jar"/>
      </patternset>
      <mapper type="flatten"/>
    </untar>
  </target>

  <target name="xp.install.svnant" unless="xp.deps.available.svnant">
    <!-- get
     src="http://subclipse.tigris.org/files/documents/906/46267/svnant-1.3.0.zip"
     dest="${xp.build.lib.dir}"
     verbose="true"
     usetimestamp="true"
    / -->
    <!-- This uses cookies and redirects the client; ant <get> does not support this -->
    <echo>Download svnant from http://subclipse.tigris.org/files/documents/906/46267/svnant-1.3.0.zip to ${xp.build.lib.dir}, please.</echo>
    <unzip
     src="${xp.build.lib.dir}/svnant-1.3.0.zip"
     dest="${xp.build.lib.dir}"
    >
      <patternset>
        <include name="**/*.jar"/>
      </patternset>
      <mapper type="flatten"/>
    </unzip>
  </target>

  <target name="xp.install.jsch" unless="xp.deps.available.jsch">
    <get
     src="http://downloads.sourceforge.net/project/jsch/jsch.jar/0.1.44/jsch-0.1.44.jar"
     dest="${xp.build.lib.dir}"
     verbose="true"
    />
  </target>
</project>
