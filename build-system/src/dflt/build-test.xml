<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-test" basedir=".">
  <available property="xp.test.exist.unittest.ini" file="${basedir}/unittest.ini"/>

  <target name="xp.unittest.mkresult">
    <mkdir dir="${build.target}/testresults"/>
    <delete>
      <fileset dir="${build.target}/testresults" includes="*.xml"/>
    </delete>

    <!-- Check for existance of some unittest .ini -->
    <pathconvert property="xp.unittest.has.configuration" refid="build.testConfigurations" setonempty="false"/>
  </target>

  <target name="xp.unittest.from-ini" unless="skip.tests" depends="xp.unittest.mkresult" if="xp.unittest.has.configuration">
    <echo>===> Testing ${ivy.organisation}#${ivy.module} - by configuration</echo>

    <!-- Execute unittest for each .ini file -->
    <apply
     executable="unittest"
     failonerror="true"
     dir="${build.target}/testresults"
     dest="${build.target}/testresults"
    >
      <env key="USE_XP" value="${build.target}/bootstrap/test/"/>
      <arg value="-l"/>
      <arg value="unittest.XmlTestListener"/>
      <chainedmapper>
        <flattenmapper/>
        <mapper type="glob" from="*.ini" to="*-result.xml"/>
      </chainedmapper>
      <targetfile/>
      <srcfile/>
      <fileset refid="build.testConfigurations"/>
    </apply>
  </target>

  <target name="xp.unittest.from-package" unless="skip.tests" if="build.testPackage" depends="xp.unittest.mkresult">
    <echo>===> Testing ${ivy.organisation}#${ivy.module} - by package</echo>

    <!-- Execute unittest -->
    <exec
     executable="unittest"
     failonerror="true"
     dir="${build.target}/testresults"
    >
      <env key="USE_XP" value="${build.target}/bootstrap/test/"/>
      <arg value="-l"/>
      <arg value="unittest.XmlTestListener"/>
      <arg value="${build.target}/testresults/testresult-package.xml"/>
      <arg value="${build.testPackage}"/>
    </exec>
  </target>

  <target name="xp.unittest" extensionOf="test" depends="xp.unittest.from-ini, xp.unittest.from-package"/>
</project>