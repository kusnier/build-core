<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-webapp" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
  <target name="xp.webapp.compile" extensionOf="compile">
    <copy todir="${build.target.webapp}">
      <fileset refid="build.webappSourceDirectory"/>
      <fileset refid="build.configSourceDirectory"/>
    </copy>
  </target>

  <target name="xp.webapp.pre-package" extensionOf="pre-package">
    <!-- Retrieve all dependee artifacts and put them into lib/ -->
    <ivy:retrieve type="xar" conf="default" pattern="${build.target.webapp}/lib/[artifact]-[revision].[ext]"/>

    <!-- Retrieve bootstrap -->
    <ivy:cachefileset type="bootstrap" conf="default" setid="bootstrap.fileset"/>
    <unzip dest="${build.target.webapp}/lib/bootstrap">
      <fileset refid="bootstrap.fileset"/>
    </unzip>

    <!-- Build .pth file -->
    <ivy:cachefileset type="xar" conf="default" setid="package.fileset"/>
    <fileset id="pth.fileset" dir="${build.target.webapp}" includes="lib/*.xar"/>

    <pathconvert property="package.fileset" pathsep="&#10;" dirsep="/">
      <path>
        <pathelement path="${build.target.webapp}/lib/bootstrap"/>
        <fileset refid="pth.fileset"/>
      </path>
      <mapper>
        <globmapper from="${build.target.webapp}/*" to="*" handledirsep="true"/>
      </mapper>
    </pathconvert>

    <!-- Output result to project.pth -->
    <echo file="${build.target.webapp}/project.pth">${package.fileset}</echo>
  </target>
  
  <target name="xp.webapp.descriptor" extensionOf="pre-package">
    <copy todir="${build.target.webapp}">
      <fileset refid="build.containerConfigDirectory"/>
      <filterset filtersfile="${basedir}/src/resources/container/webapp.properties">
        <filter token="name" value="${ivy.module}-${ivy.revision}"/>
        <filter token="php_include_path" value="~:@base@/@name@/bootstrap"/>
      </filterset>
    </copy>
  </target>

  <target name="xp.webapp.package" extensionOf="package" depends="ivy-info, xp.build.number">
    <zip destfile="${build.target}/${ivy.module}-webapp-${ivy.new.revision}.zip">
      <fileset dir="${build.target.webapp}"/>
    </zip>
  </target>
</project>
