<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-tagdeploy" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
  <target name="publish:tag" depends="xp.provide.dependencies, ivy-info, xp.get.tagname, xp.build.number">
    <echo>===> Deploying to tag ${xp.build.tag}</echo>
    <echo>     Repository: ${ivy.extra.repository}</echo>

    <svn svnkit="true" javahl="false">
      <checkout url="${ivy.extra.repository}/${xp.build.tag}" destPath="${build.target}/${xp.build.tag}"/>
    </svn>

    <sync todir="${build.target}/${xp.build.tag}" includeEmptyDirs="true">
      <zipfileset src="${build.target}/${ivy.module}-webapp-${ivy.new.revision}.zip"/>
      <preserveintarget>
        <include name="**/.svn/**"/>
      </preserveintarget>
    </sync>

    <svn svnkit="true" javahl="false">
      <add dir="${build.target}/${xp.build.tag}" force="true" recurse="true"/>
      <delete>
        <svnFileSet dir="${build.target}/${xp.build.tag}">
          <svnMissing/>
        </svnFileSet>
      </delete>

      <propset path="${build.target}/${xp.build.tag}" name="xp.ivy.version" value="${ivy.new.revision}"/>
      <commit dir="${build.target}/${xp.build.tag}" message="- Publishing ${ivy.module}-${ivy.new.revision}"/>
    </svn>
  </target>

  <target name="xp.get.tagname" depends="xp.build.mode, xp.tagname.integration, xp.tagname.release, xp.tagname.milestone"/>

  <target name="xp.tagname.release" if="xp.build.mode.release">
    <property name="xp.build.tag">${ivy.extra.tag}_RELEASE</property>
  </target>

  <target name="xp.tagname.milestone" if="xp.build.mode.milestone">
    <property name="xp.build.tag">${ivy.extra.tag}_QARELEASE</property>
  </target>

  <target name="xp.tagname.integration" if="xp.build.mode.integration">
    <fail>Target not supported for integration build.</fail>
  </target>
</project>