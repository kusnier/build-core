<?xml version="1.0" encoding="UTF-8"?>
<project name="xp-framework-app" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
  <target name="xp.app.compile" extensionOf="compile">
    <copy todir="${build.target.app}">
      <fileset refid="build.appSourceDirectory"/>
      <fileset refid="build.configSourceDirectory"/>
    </copy>
    <copy todir="${build.target.app}/src">
      <fileset refid="build.sources.fileset.php"/>
      <cutdirsmapper dirs="1"/>
    </copy>
    <copy todir="${build.target.app}/xsl">
      <fileset refid="build.sources.fileset.xsl"/>
      <cutdirsmapper dirs="1"/>
    </copy>
  </target>

  <target name="xp.app.pre-package" extensionOf="pre-package">
    <!-- Retrieve all dependee artifacts and put them into lib/ -->
    <ivy:retrieve type="xar" conf="default" pattern="${build.target.app}/lib/[artifact]-[revision].[ext]"/>

    <!-- Retrieve bootstrap -->
    <ivy:cachefileset type="bootstrap" conf="default" setid="bootstrap.fileset"/>
    <unzip dest="${build.target.app}/lib/bootstrap">
      <fileset refid="bootstrap.fileset"/>
    </unzip>

    <!-- Build .pth file -->
    <ivy:cachefileset type="xar" conf="default" setid="package.fileset"/>
    <fileset id="pth.fileset" dir="${build.target.app}" includes="lib/*.xar"/>

    <pathconvert property="package.fileset" pathsep="&#10;" dirsep="/">
      <path>
        <fileset refid="pth.fileset"/>
        <pathelement path="${build.target.app}/lib/bootstrap"/>
      </path>
      <mapper>
        <globmapper from="${build.target.app}/*" to="*" handledirsep="true"/>
      </mapper>
    </pathconvert>

    <!-- Output result to project.pth -->
    <echo file="${build.target.app}/project.pth">${package.fileset}</echo>
  </target>
  
  <target name="xp.app.descriptor" extensionOf="pre-package">
    <copy todir="${build.target.app}">
      <fileset refid="build.containerConfigDirectory"/>
      <filterset filtersfile="${basedir}/src/resources/container/app.properties">
        <filter token="name" value="${ivy.module}-${ivy.revision}"/>
        <filter token="php_include_path" value="~:@base@/@name@/bootstrap"/>
      </filterset>
    </copy>
  </target>

  <target name="xp.app.package" extensionOf="package" depends="ivy-info, xp.build.number">
    <zip destfile="${build.target}/${ivy.module}-app-${ivy.new.revision}.zip">
      <fileset dir="${build.target}" includes="app/**"/>
    </zip>
  </target>
</project>
